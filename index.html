<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Auto-Importer (RMS Sync) v2.0</title>
    <style>
        :root {
            --bg-primary: #1C1C1C;
            --bg-secondary: #242424;
            --bg-tertiary: #2D2D2D;
            --bg-card: #2A2A2A;
            --supabase-green: #3ECF8E;
            --supabase-green-hover: #2EAA6E;
            --supabase-green-light: rgba(62, 207, 142, 0.1);
            --text-primary: #EDEDED;
            --text-secondary: #8B949E;
            --border-color: #3D3D3D;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .header {
            background: var(--bg-secondary);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--supabase-green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .logo-text span {
            color: var(--supabase-green);
        }

        .main-layout {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            padding: 24px;
            border-right: 1px solid var(--border-color);
        }

        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 32px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: var(--border-color);
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .wizard-step.active .step-number {
            background: var(--supabase-green);
            border-color: var(--supabase-green);
            color: var(--bg-primary);
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .wizard-step.active .step-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: var(--bg-tertiary);
        }

        .dropzone:hover {
            border-color: var(--supabase-green);
            background: var(--supabase-green-light);
        }

        .dropzone-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--supabase-green-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dropzone-text {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .dropzone-subtext {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .dropzone input {
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--supabase-green);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--supabase-green-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-group {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .tab.active {
            color: var(--supabase-green);
            background: var(--supabase-green-light);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background: var(--supabase-green);
        }

        .status-dot.disconnected {
            background: #EF4444;
        }

        .footer {
            background: var(--bg-secondary);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--supabase-green-light);
            border: 1px solid var(--supabase-green);
            border-radius: 8px;
            margin-top: 16px;
        }

        .preview-container {
            margin-top: 24px;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th {
            background: var(--bg-tertiary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-top: 1px solid var(--border-color);
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 4px;
            background: var(--bg-tertiary);
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .template-item {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .template-item:hover {
            border-color: var(--supabase-green);
        }

        .template-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .template-item-table {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 24px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--supabase-green);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10B981;
            color: #10B981;
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #EF4444;
            color: #EF4444;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">RS</div>
                <div class="logo-text">RMS <span>Sync</span></div>
            </div>
            <div class="header-actions">
                <div class="connection-status">
                    <div class="status-dot disconnected" id="statusDot"></div>
                    <span id="statusText">Non connecte</span>
                </div>
            </div>
        </header>
        <div class="main-layout">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Mode d'utilisation</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button id="btnModeManual" class="btn btn-primary btn-sm"
                            style="width: 100%; justify-content: flex-start;" onclick="window.switchAppMode('manual')">
                            <span>üõ†Ô∏è Assistant (Manuel)</span>
                        </button>
                        <button id="btnModeAuto" class="btn btn-secondary btn-sm"
                            style="width: 100%; justify-content: flex-start;" onclick="window.switchAppMode('auto')">
                            <span>üöÄ Automatique (Expert)</span>
                        </button>
                    </div>
                </div>
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Templates</h3>
                    <ul class="template-list" id="templateList">
                        <li class="template-item">
                            <div class="template-item-name">Chargement...</div>
                        </li>
                    </ul>
                </div>
                <!-- Section H√¥tels -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Configuration</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" style="width: 100%; justify-content: flex-start;"
                            onclick="window.openHotelManager()">
                            <span>üè® G√©rer les h√¥tels</span>
                        </button>
                    </div>
                </div>
                <!-- Section Cache -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Stockage</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" style="width: 100%; justify-content: flex-start;"
                            onclick="window.openCacheManager()">
                            <span>üìÇ G√©rer le cache</span>
                        </button>
                    </div>
                </div>
                <!-- Section Aide -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Besoin d'aide ?</h3>
                    <button class="btn btn-secondary btn-sm" style="width: 100%; justify-content: flex-start;"
                        onclick="toggleAide()">
                        <span>üìñ Guide d'utilisation</span>
                    </button>
                </div>
            </aside>
            <main class="main-content">
                <!-- MODE AUTOMATIQUE -->
                <section class="card fade-in" id="autoModeContainer" style="display: none;">
                    <div class="card-header">
                        <h2 class="card-title">üöÄ Traitement Automatique (One-Click)</h2>
                    </div>
                    <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 24px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">1. Choisir l'H√¥tel</label>
                            <select class="form-select" id="autoHotelId">
                                <option value="">Choisir un h√¥tel...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">2. Cat√©gorie de Rapport</label>
                            <select class="form-select" id="autoCategory">
                                <option value="">D√©tecter automatiquement...</option>
                                <option value="RAPPORT PLANNING D-EDGE">D-EDGE Planning (Tarifs/Dispo)</option>
                                <option value="RAPPORT R√âSERVATIONS EN COURS D-EDGE">D-EDGE R√©servations en cours
                                </option>
                                <option value="RAPPORT HISTORIQUE DES R√âSERVATIONS">D-EDGE Historique R√©servations
                                </option>
                                <option value="RAPPORT OTA INSIGHT">OTA Insight (Multi-onglets)</option>
                                <option value="DATES SALONS ET √âV√âNEMENTS">Salons & √âv√©nements</option>
                            </select>
                        </div>
                    </div>

                    <div id="otaTabsContainer"
                        style="display: none; margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px dashed var(--border-color);">
                        <label class="form-label">S√©lectionner l'onglet OTA Insight</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="otaTabsButtons">
                            <!-- Buttons injected by JS -->
                        </div>
                    </div>

                    <div class="dropzone" id="autoDropzone">
                        <div class="dropzone-icon">üì•</div>
                        <div class="dropzone-text">D√©posez le fichier pour traitement imm√©diat</div>
                        <div class="dropzone-subtext">Le fichier sera transform√© et envoy√© vers Supabase selon les
                            r√®gles expertes</div>
                        <input type="file" id="autoFileInput" accept=".xlsx,.xls,.csv">
                    </div>

                    <div id="autoStatus" style="margin-top: 24px; display: none;">
                        <div class="message" id="autoStatusMessage"></div>
                        <div style="margin-top: 16px; max-height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 12px; font-family: monospace; font-size: 12px; border-radius: 4px;"
                            id="autoLogs">
                            > Pr√™t pour le traitement...
                        </div>
                    </div>
                </section>

                <div class="wizard" id="manualWizard">
                    <div class="wizard-steps">
                        <div class="wizard-step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">Source</div>
                        </div>
                        <div class="wizard-step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Destination</div>
                        </div>
                        <div class="wizard-step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Mapping</div>
                        </div>
                        <div class="wizard-step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label">Import</div>
                        </div>
                    </div>
                    <section class="card fade-in" id="step1">
                        <div class="card-header">
                            <h2 class="card-title">1. Configuration & Source</h2>
                        </div>
                        
                        <!-- Zone de selection Hotel/Modele (D√©plac√©e ici pour visibilit√© imm√©diate) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">üè® S√©lectionner l'H√¥tel</label>
                                <select class="form-select" id="hotelIdInput">
                                    <option value="">Choisir un h√¥tel...</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">üìÑ Charger un Mod√®le (Optionnel)</label>
                                <select class="form-select" id="manualTemplateSelect" onchange="if(this.value) applyTemplate(this.value)">
                                    <option value="">S√©lectionner un mod√®le...</option>
                                </select>
                            </div>
                        </div>

                        <div class="dropzone" id="dropzone">
                            <div class="dropzone-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" width="32" height="32">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                            </div>
                            <div class="dropzone-text">Glissez-deposez votre fichier ici</div>
                            <div class="dropzone-subtext">ou cliquez pour selectionner - CSV, XLSX, XLS</div>
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                        </div>
                        <div id="uploadedFileContainer" style="display: none;">
                            <div class="uploaded-file">
                                <div class="uploaded-file-info">
                                    <div class="uploaded-file-name" id="uploadedFileName"></div>
                                    <div class="uploaded-file-meta" id="uploadedFileMeta"></div>
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="clearFile()">X</button>
                            </div>
                        </div>
                        <div id="sheetSelectContainer" style="display: none; margin-top: 24px;">
                            <div class="form-group">
                                <label class="form-label">Selectionner l'onglet (Excel)</label>
                                <select class="form-select" id="sheetSelect"
                                    onchange="window.state.headerRowIndex = null; window.state.ignoredColumns = []; window.loadPreview(window.state.uploadedFile.filepath, this.value)">
                                    <option value="">Choisir un onglet...</option>
                                </select>
                            </div>
                        </div>
                        <div id="previewContainer" style="display: none; margin-top: 24px;">
                            <div class="card-header"
                                style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                                <h3 class="card-title" style="font-size: 1rem;">Aper√ßu des donn√©es</h3>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="window.loadPreview(window.state.uploadedFile.filepath, document.getElementById('sheetSelect').value)">
                                        <span>üîÑ Rafra√Æchir</span>
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="insertCustomHeader()">
                                        <span>‚ûï Ins√©rer En-t√™tes</span>
                                    </button>
                                    <span class="badge" id="rowCountBadge"></span>
                                </div>
                            </div>
                            <div class="preview-container">
                                <table class="data-table" id="previewTable">
                                    <thead id="previewTableHead"></thead>
                                    <tbody id="previewTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="btn-group" id="step1Actions" style="display: none;">
                            <button class="btn btn-primary" onclick="goToStep(2)">Suivant</button>
                        </div>
                    </section>
                    <section class="card fade-in" id="step2" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title">2. Destination Supabase</h2>
                            <button class="btn btn-secondary btn-sm" onclick="loadTables()">Actualiser</button>
                        </div>
                        <div class="tabs">
                            <button class="tab active" data-tab="append" onclick="switchTab('append')">Mise a jour
                                (Append)</button>
                            <button class="tab" data-tab="create" onclick="switchTab('create')">Nouvelle table
                                (Create)</button>
                        </div>
                        <div id="tab-append">
                            <div class="form-group">
                                <label class="form-label">Table existante</label>
                                <select class="form-select" id="existingTableSelect"
                                    onchange="loadTableColumns(this.value)">
                                    <option value="">Selectionner une table...</option>
                                </select>
                            </div>
                        </div>
                        <div id="tab-create" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Nom de la nouvelle table</label>
                                <input type="text" class="form-input" id="newTableName"
                                    placeholder="ex: import_stocks_2026">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="goToStep(1)">Precedent</button>
                            <button class="btn btn-primary" onclick="goToStep(3)">Suivant</button>
                        </div>
                    </section>
                    <section class="card fade-in" id="step3" style="display: none;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="form-group" style="margin-bottom: 0; padding: 0; background: none;">
                                <label class="form-label"
                                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                                    <input type="checkbox" id="splitDatetimeCheckbox"
                                        style="width: 18px; height: 18px;">
                                    <span>D√©couper Date/Heure auto</span>
                                </label>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="autoDetectTypes()">
                                ‚ú® Auto-d√©tecter les types
                            </button>
                        </div>
                        <div class="mapping-container" id="mappingContainer"></div>
                        <datalist id="targetColumnsList"></datalist>

                        <div class="btn-group" style="margin-top: 32px;">
                            <button class="btn btn-secondary" onclick="goToStep(2)">Precedent</button>
                            <button class="btn btn-primary" onclick="goToStep(4)">Suivant</button>
                        </div>
                    </section>
                    <section class="card fade-in" id="step4" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title">4. Import</h2>
                        </div>
                        <div id="importSummary">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="summaryRows">0</div>
                                    <div class="stat-label">Lignes a importer</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="summaryColumns">0</div>
                                    <div class="stat-label">Colonnes</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="summaryTable">-</div>
                                    <div class="stat-label">Table cible</div>
                                </div>
                            </div>
                        </div>

                        <!-- Zone de sauvegarde de template -->
                        <div class="form-group"
                            style="margin-top: 24px; padding: 16px; border: 1px solid var(--border-color); border-radius: 8px;">
                            <h3 class="sidebar-title">Sauvegarder ce modele</h3>
                            <div style="display: flex; gap: 16px;">
                                <input type="text" class="form-input" id="templateName"
                                    placeholder="Nom du modele (ex: Import Hebdo)">
                                <button class="btn btn-secondary" onclick="saveTemplate()">Enregistrer</button>
                            </div>
                        </div>

                        <div id="importResult"></div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="goToStep(3)">Precedent</button>
                            <button class="btn btn-secondary" onclick="resetAll()">Reinitialiser</button>
                            <button class="btn btn-primary" id="importBtn" onclick="executeImport()">Lancer
                                l'import</button>
                        </div>
                    </section>
                </div>

                <!-- Modal Aide - Global -->
                <div id="aideModal" class="modal"
                    style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); overflow-y: auto;">
                    <div class="modal-content"
                        style="background: var(--bg-card); margin: 5% auto; padding: 32px; border-radius: 12px; width: 80%; max-width: 800px; border: 1px solid var(--border-color); position: relative;">
                        <button class="btn btn-secondary btn-sm" style="position: absolute; right: 20px; top: 20px;"
                            onclick="toggleAide()">Fermer</button>
                        <h1 style="color: var(--supabase-green); margin-bottom: 24px;">üöÄ Guide d'utilisation</h1>

                        <h3 style="margin-top: 24px;">1. Source</h3>
                        <p>Glissez votre fichier <strong>Excel</strong> ou <strong>CSV</strong>. Choisissez l'onglet
                            correct et v√©rifiez l'aper√ßu.</p>

                        <h3 style="margin-top: 24px;">2. Destination</h3>
                        <p><strong>Append :</strong> Ajoutez des lignes √† une table existante (votre mapping doit
                            correspondre aux noms de colonnes Supabase).<br>
                            <strong>Create :</strong> Cr√©ez une nouvelle table √† partir de votre fichier.
                        </p>

                        <h3 style="margin-top: 24px;">3. Mapping et Types</h3>
                        <p>C'est l'√©tape la plus importante :</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Renommer :</strong> En mode 'Create', tapez le nom souhait√© pour la colonne dans
                                la zone de texte.</li>
                            <li><strong>Types :</strong> Choisissez 'Date' pour convertir les dates proprement sans les
                                heures inutiles.</li>
                            <li><strong>D√©couper :</strong> Cochez l'option en haut pour s√©parer les colonnes 'Date et
                                Heure' en deux colonnes distinctes.</li>
                        </ul>

                        <h3 style="margin-top: 24px;">4. Import et Cache</h3>
                        <p>V√©rifiez le r√©sum√©, sauvegardez un <strong>Template</strong> si n√©cessaire. <br>
                            <strong>Cache :</strong> Utilisez le bouton "G√©rer le cache" dans la barre lat√©rale pour
                            voir les fichiers temporaires stock√©s sur le serveur et lib√©rer de l'espace si besoin.
                        </p>
                    </div>
                </div>

                <!-- Modal Gestion des H√¥tels -->
                <div class="modal" id="hotelModal">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h2 class="modal-title">üè® Gestion des H√¥tels</h2>
                            <button class="btn btn-secondary btn-sm" onclick="closeModal('hotelModal')">X</button>
                        </div>
                        <div
                            style="margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                            <h3 style="font-size: 0.9rem; margin-bottom: 12px; color: var(--supabase-green);">Ajouter un
                                nouvel h√¥tel</h3>
                            <div
                                style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 12px; align-items: end;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 0.8rem;">ID H√¥tel (ex: H001)</label>
                                    <input type="text" class="form-input" id="newHotelId" placeholder="ID unique">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 0.8rem;">Nom de l'h√¥tel</label>
                                    <input type="text" class="form-input" id="newHotelName" placeholder="Nom complet">
                                </div>
                                <button class="btn btn-primary" onclick="window.createHotel()">Ajouter</button>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID H√¥tel</th>
                                        <th>Nom</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hotelListContainer">
                                    <!-- Liste des h√¥tels inject√©e ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal Gestion du Cache -->
                <div id="cacheModal" class="modal"
                    style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); overflow-y: auto;">
                    <div class="modal-content"
                        style="background: var(--bg-card); margin: 5% auto; padding: 32px; border-radius: 12px; width: 80%; max-width: 800px; border: 1px solid var(--border-color); position: relative;">
                        <button class="btn btn-secondary btn-sm" style="position: absolute; right: 20px; top: 20px;"
                            onclick="window.closeCacheManager()">Fermer</button>
                        <h2 style="color: var(--supabase-green); margin-bottom: 24px;">üìÇ Gestion du Cache</h2>
                        <p style="margin-bottom: 16px; color: var(--text-secondary);">Fichiers temporaires actuellement
                            stock√©s sur le serveur.</p>

                        <div class="preview-container"
                            style="max-height: 400px; overflow-y: auto; margin-bottom: 24px;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fichier</th>
                                        <th>Date d'upload</th>
                                        <th>Taille</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="cacheListContainer">
                                    <!-- Liste g√©n√©r√©e par JS -->
                                </tbody>
                            </table>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <button class="btn btn-secondary" onclick="window.closeCacheManager()">Annuler</button>
                            <button class="btn btn-danger" style="background: #EF4444; color: white;"
                                onclick="window.clearAllCache()">üóëÔ∏è Tout vider</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        <footer class="footer">
            <div>RMS Sync v2.0 - 21 Janvier 2026</div>
            <div>Supreme par Supabase</div>
        </footer>
    </div>
    <script>
        (function () {
            window.state = {
                currentStep: 1,
                currentTab: 'append',
                uploadedFile: null,
                previewData: null,
                sourceHeaders: [],
                sourceColumns: [],
                targetTables: [],
                targetColumns: [],
                mapping: {},
                columnTypes: {},
                importMode: 'append',
                templates: [],
                ignoredRows: [],
                ignoredColumns: [],
                headerRowIndex: null
            };
            var state = window.state;
            var API_BASE = '/api';

            function initializeApp() {
                setupEventListeners();
                loadTemplates();
                loadTables();
            }

            function setupEventListeners() {
                var dropzone = document.getElementById('dropzone');
                var fileInput = document.getElementById('fileInput');
                if (dropzone && fileInput) {
                    dropzone.onclick = function (e) {
                        if (e.target !== fileInput) {
                            fileInput.click();
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    };
                    dropzone.addEventListener('dragover', function (e) { e.preventDefault(); dropzone.classList.add('dragover'); });
                    dropzone.addEventListener('dragleave', function () { dropzone.classList.remove('dragover'); });
                    dropzone.addEventListener('drop', function (e) {
                        e.preventDefault();
                        dropzone.classList.remove('dragover');
                        if (e.dataTransfer.files.length > 0) {
                            handleFileUpload(e.dataTransfer.files[0]);
                        }
                    });
                }
                if (fileInput) {
                    fileInput.addEventListener('change', function (e) {
                        if (e.target.files.length > 0) {
                            handleFileUpload(e.target.files[0]);
                        }
                    });
                }
            }

            function handleFileUpload(file) {
                var formData = new FormData();
                formData.append('file', file);

                document.getElementById('dropzone').innerHTML = '<div class="dropzone-text">Chargement en cours...</div>';

                fetch(API_BASE + '/upload', { method: 'POST', body: formData })
                    .then(function (response) {
                        if (!response.ok) {
                            return response.json().then(function (err) { throw new Error(err.error || response.statusText); });
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        state.uploadedFile = data;
                        state.sourceHeaders = data.headers || [];
                        displayUploadedFile(data);
                        if (data.sheets && data.sheets.length > 0) {
                            displaySheetSelect(data.sheets);
                            window.loadPreview(window.state.uploadedFile.filepath, data.sheets[0]);
                        } else {
                            window.loadPreview(window.state.uploadedFile.filepath, null);
                        }
                    })
                    .catch(function (error) {
                        alert('Erreur: ' + error.message);
                        resetDropzone();
                    });
            }

            function resetDropzone() {
                var dz = document.getElementById('dropzone');
                if (dz) {
                    dz.innerHTML = `
                        <div class="dropzone-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="32" height="32">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                        </div>
                        <div class="dropzone-text">Glissez-deposez votre fichier ici</div>
                        <div class="dropzone-subtext">ou cliquez pour selectionner - CSV, XLSX, XLS</div>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                    `;
                    setupEventListeners();
                }
            }

            function displayUploadedFile(data) {
                if (!data || !data.file_type) return;
                document.getElementById('dropzone').style.display = 'none';
                document.getElementById('uploadedFileContainer').style.display = 'block';
                document.getElementById('uploadedFileName').textContent = data.filename;
                var meta = (data.file_type || 'INC').toUpperCase() + ' - ' + (data.total_rows || 0) + ' lignes';
                if (data.sheets && data.sheets.length > 0) {
                    meta += ' - ' + data.sheets.length + ' onglet(s)';
                }
                document.getElementById('uploadedFileMeta').textContent = meta;
                document.getElementById('step1Actions').style.display = 'flex';
            }

            function displaySheetSelect(sheets) {
                var container = document.getElementById('sheetSelectContainer');
                var select = document.getElementById('sheetSelect');
                if (select) {
                    select.innerHTML = sheets.map(function (sheet) { return '<option value="' + sheet + '">' + sheet + '</option>'; }).join('');
                    container.style.display = 'block';
                }
            }

            window.loadPreview = function (filename, sheetName, hIndex) {
                if (!filename) return;
                var hRow = (hIndex !== undefined) ? hIndex : state.headerRowIndex;
                fetch(API_BASE + '/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: filename,
                        sheet_name: sheetName,
                        header_row: hRow
                    })
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        state.previewData = data;
                        state.sourceHeaders = data.headers;
                        state.sourceColumns = data.normalized_headers;
                        // On ne reset ignoredRows que si on change de fichier/onglet, pas si on change de header row
                        if (hIndex === undefined) state.ignoredRows = [];
                        displayPreview(data);
                    })
                    .catch(function (error) { alert('Erreur: ' + error.message); });
            }

            function displayPreview(data) {
                if (!data) return;
                document.getElementById('previewContainer').style.display = 'block';
                var ignoredCount = state.ignoredRows.length;
                var effectiveRows = data.total_rows - ignoredCount;
                var badgeText = data.total_rows + ' lignes' + (ignoredCount > 0 ? ' (' + effectiveRows + ' apres filtrage)' : '');
                document.getElementById('rowCountBadge').textContent = badgeText;
                var thead = document.getElementById('previewTableHead');
                var tbody = document.getElementById('previewTableBody');

                if (thead && tbody) {
                    var headersToDisplay = state.customHeaders || data.headers;

                    thead.innerHTML = '<tr><th>Actions</th>' + headersToDisplay.map(function (h, i) {
                        var isIgnored = state.ignoredColumns.includes(h);
                        var style = isIgnored ? 'text-decoration: line-through; opacity: 0.5;' : '';
                        var icon = isIgnored ? '‚ûï' : 'üóëÔ∏è'; // Plus to restore, Trash to delete
                        return '<th style="' + style + '">' +
                            '<div style="display: flex; align-items: center; justify-content: space-between; gap: 5px;">' +
                            '<span>' + h + '</span>' +
                            '<button class="btn btn-sm btn-light" style="padding: 0 4px;" onclick="window.toggleIgnoreColumn(\'' + h.replace(/'/g, "\\'") + '\')">' + icon + '</button>' +
                            '</div>' +
                            '</th>';
                    }).join('') + '</tr>';

                    if (state.isInsertingHeader) {
                        var inputRow = '<tr style="background: #e3f2fd; border-bottom: 2px solid #2196f3;">' +
                            '<td><button class="btn btn-sm btn-primary" onclick="confirmCustomHeader()">Valider</button> <button class="btn btn-sm btn-secondary" onclick="cancelCustomHeader()">Annuler</button></td>' +
                            headersToDisplay.map(function (h, i) {
                                return '<td><input type="text" class="form-input custom-header-input" data-index="' + i + '" value="' + h + '" style="min-width: 80px;"></td>';
                            }).join('') +
                            '</tr>';
                        tbody.innerHTML = inputRow + data.preview.map(renderRow).join('');
                    } else {
                        tbody.innerHTML = data.preview.map(renderRow).join('');
                    }
                }
            }

            function renderRow(row, idx) {
                // Si on a des customHeaders, les cl√©s de 'row' ne correspondent plus forc√©ment aux headers affich√©s
                // row est toujours index√© par les headers ORIGINAUX du fichier (ou 0, 1, 2...)
                // C'est un peu d√©licat. Pour l'affichage, on it√®re sur les keys de row ou les headers originaux ?
                // Le plus simple: on utilise data.headers (les originaux) pour lire la row.
                var originalHeaders = state.previewData.headers;

                var isIgnoredRow = state.ignoredRows.includes(idx);
                var isHeader = state.headerRowIndex === idx;
                var rowStyle = isIgnoredRow ? 'opacity: 0.5; text-decoration: line-through; background: rgba(0,0,0,0.05);' : '';
                if (isHeader) rowStyle = 'background: rgba(var(--supabase-green-rgb), 0.1); font-weight: bold;';

                return '<tr style="' + rowStyle + '">' +
                    '<td style="white-space: nowrap;">' +
                    '<button class="btn btn-secondary btn-sm" style="padding: 2px 8px; margin-right: 4px;" onclick="toggleIgnoreRow(' + idx + ')">' + (isIgnoredRow ? 'Restaurer' : 'Ignorer') + '</button>' +
                    '<button class="btn btn-primary btn-sm" style="padding: 2px 8px;" onclick="useAsHeader(' + idx + ')">En-t√™tes</button>' +
                    '</td>' +
                    originalHeaders.map(function (h) {
                        var isIgnoredCol = state.ignoredColumns.includes(h);
                        var cellStyle = isIgnoredCol ? 'opacity: 0.3; background: #f0f0f0;' : '';
                        return '<td style="' + cellStyle + '">' + (row[h] || '') + '</td>';
                    }).join('') + '</tr>';
            }

            window.insertCustomHeader = function () {
                state.isInsertingHeader = true;
                // Init custom headers with existing if not set
                if (!state.customHeaders) {
                    state.customHeaders = [...state.previewData.headers];
                }
                displayPreview(state.previewData);
            }

            window.cancelCustomHeader = function () {
                state.isInsertingHeader = false;
                state.customHeaders = null;
                displayPreview(state.previewData);
            }

            window.confirmCustomHeader = function () {
                var inputs = document.querySelectorAll('.custom-header-input');
                var newHeaders = [];
                inputs.forEach(function (input) {
                    newHeaders.push(input.value);
                });
                state.customHeaders = newHeaders;
                state.sourceHeaders = newHeaders; // Update source headers for mapping
                state.headerRowIndex = -1; // Special flag for custom header
                state.isInsertingHeader = false;
                state.ignoredRows = [];
                displayPreview(state.previewData);
            }

            window.toggleIgnoreColumn = function (colName) {
                var idx = state.ignoredColumns.indexOf(colName);
                if (idx === -1) {
                    state.ignoredColumns.push(colName);
                } else {
                    state.ignoredColumns.splice(idx, 1);
                }
                // R√©afficher les donn√©es sans recharger
                displayPreview(state.previewData);
            }

            window.useAsHeader = function (idx) {
                if (!confirm('Utiliser cette ligne comme noms de colonnes ? (Cela rechargera le fichier)')) return;
                // Calculer l'index absolu dans le fichier original
                var currentH = state.headerRowIndex;
                var newH;

                if (currentH === null) {
                    // Mode "Raw" (header=None) : l'index affich√© est l'index absolu
                    newH = idx;
                } else {
                    // Mode avec header existant : l'index 0 correspond √† la ligne suivant le header actuel
                    newH = currentH + idx + 1;
                }

                state.headerRowIndex = newH;
                state.ignoredRows = []; // Crucial: les index changent
                state.ignoredColumns = []; // Reset colonnes car les noms changent
                var sheet = document.getElementById('sheetSelect') ? document.getElementById('sheetSelect').value : null;
                window.loadPreview(state.uploadedFile.filepath, sheet, newH);
            }

            window.toggleIgnoreRow = function (idx) {
                var index = state.ignoredRows.indexOf(idx);
                if (index > -1) {
                    state.ignoredRows.splice(index, 1);
                } else {
                    state.ignoredRows.push(idx);
                }
                displayPreview(state.previewData);
            }

            window.resetAll = function () {
                if (confirm('Voulez-vous vraiment tout reinitialiser ?')) {
                    clearFile();
                    goToStep(1);
                }
            }

            window.clearFile = function () {
                state.uploadedFile = null;
                state.previewData = null;
                state.sourceHeaders = [];
                state.mapping = {};
                state.columnTypes = {};
                document.getElementById('dropzone').style.display = 'block';
                document.getElementById('uploadedFileContainer').style.display = 'none';
                document.getElementById('sheetSelectContainer').style.display = 'none';
                document.getElementById('previewContainer').style.display = 'none';
                document.getElementById('step1Actions').style.display = 'none';
                var fi = document.getElementById('fileInput');
                if (fi) fi.value = '';
                resetDropzone();
            }

            window.goToStep = function (step) {
                if (step > state.currentStep && !validateStep(state.currentStep)) {
                    return;
                }
                document.querySelectorAll('.wizard-step').forEach(function (s) {
                    s.classList.remove('active');
                    if (parseInt(s.dataset.step) < step) {
                        s.classList.add('completed');
                    } else {
                        s.classList.remove('completed');
                    }
                });
                document.querySelectorAll('.card[id^="step"]').forEach(function (c) { c.style.display = 'none'; });
                var activeStep = document.querySelector('.wizard-step[data-step="' + step + '"]');
                if (activeStep) activeStep.classList.add('active');
                var stepEl = document.getElementById('step' + step);
                if (stepEl) stepEl.style.display = 'block';
                state.currentStep = step;
                if (step === 2) { setupStep2(); }
                if (step === 3) { setupStep3(); }
                if (step === 4) { setupStep4(); }
            }

            function validateStep(step) {
                if (step === 1) {
                    if (!state.uploadedFile) { alert('Veuillez d\'abord uploader un fichier'); return false; }
                }
                if (step === 2) {
                    if (state.importMode === 'append') {
                        var table = document.getElementById('existingTableSelect').value;
                        if (!table) { alert('Veuillez selectionner une table cible'); return false; }
                    } else {
                        var tableName = document.getElementById('newTableName').value.trim();
                        if (!tableName) { alert('Veuillez entrer un nom de table'); return false; }
                    }
                }
                return true;
            }

            function setupStep2() {
                // Refresh table list
                loadTables();
            }

            function loadTables() {
                fetch(API_BASE + '/tables')
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        state.targetTables = data.tables || [];
                        var select = document.getElementById('existingTableSelect');
                        if (select) {
                            var currentVal = select.value;
                            select.innerHTML = '<option value="">Selectionner une table...</option>' +
                                state.targetTables.map(function (t) { return '<option value="' + t + '">' + t + '</option>'; }).join('');
                            if (currentVal && state.targetTables.includes(currentVal)) {
                                select.value = currentVal;
                                loadTableColumns(currentVal); // Forcer le chargement des colonnes pour la datalist
                            }
                        }
                    })
                    .catch(function (error) { console.error('Erreur:', error); });
            }

            window.loadTableColumns = function (tableName) {
                if (!tableName) return;
                fetch(API_BASE + '/tables/' + tableName + '/columns')
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        state.targetColumns = data.columns || [];
                        if (state.currentStep === 3) generateMapping();
                    })
                    .catch(function (error) { console.error('Erreur:', error); });
            }

            window.switchTab = function (tab) {
                state.importMode = tab;
                document.querySelectorAll('.tab').forEach(function (t) { t.classList.remove('active'); });
                var activeTab = document.querySelector('.tab[data-tab="' + tab + '"]');
                if (activeTab) activeTab.classList.add('active');
                document.getElementById('tab-append').style.display = tab === 'append' ? 'block' : 'none';
                document.getElementById('tab-create').style.display = tab === 'create' ? 'block' : 'none';

                state.mapping = {};
                state.columnTypes = {};
            }

            function setupStep3() {
                generateMapping();
            }

            function generateMapping() {
                var container = document.getElementById('mappingContainer');
                if (!container) return;
                var sourceHeaders = state.sourceHeaders;
                var targetHeaders;
                if (state.importMode === 'append') {
                    targetHeaders = state.targetColumns.map(function (c) { return c.column_name; });
                } else {
                    targetHeaders = sourceHeaders.map(function (h) { return snakeCase(h); });
                }

                var mapping = state.mapping || {};
                var columnTypes = state.columnTypes || {};

                // Mettre √† jour la datalist globale
                var datalist = document.getElementById('targetColumnsList');
                if (datalist) {
                    datalist.innerHTML = targetHeaders.map(function (h) { return '<option value="' + h + '">'; }).join('');
                }

                container.innerHTML = sourceHeaders.map(function (header, index) {
                    var normalizedHeader = snakeCase(header);
                    var targetCol = mapping[header];
                    if (targetCol === undefined) {
                        targetCol = targetHeaders.find(function (t) { return t.toLowerCase() === normalizedHeader.toLowerCase(); });
                        if (!targetCol && index < targetHeaders.length && state.importMode === 'create') { targetCol = targetHeaders[index]; }
                    }

                    mapping[header] = targetCol || (state.importMode === 'create' ? normalizedHeader : '');
                    if (!columnTypes[header]) columnTypes[header] = 'text';

                    var destinationHTML = '<div style="position: relative;">' +
                        '<input type="text" class="form-input" style="padding: 8px;" ' +
                        'list="targetColumnsList" ' +
                        'placeholder="Choisir ou renommer..." ' +
                        'value="' + mapping[header] + '" ' +
                        'oninput="updateMapping(\'' + header + '\', this.value)" ' +
                        'onfocus="this.select()">' +
                        '</div>';

                    return '<div class="mapping-row" style="display: grid; grid-template-columns: 1.2fr 40px 1.5fr 120px; gap: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; align-items: center;">' +
                        '<div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><div class="form-label" title="' + header + '">Source: ' + header + '</div></div>' +
                        '<div style="text-align: center; color: var(--supabase-green);">-></div>' +
                        '<div><label class="form-label">Destination</label>' + destinationHTML + '</div>' +
                        '<div><label class="form-label">Type</label><select class="form-select" style="padding: 8px;" onchange="updateColumnType(\'' + header + '\', this.value)"><option value="text" ' + (columnTypes[header] === 'text' ? 'selected' : '') + '>Texte</option><option value="numeric" ' + (columnTypes[header] === 'numeric' ? 'selected' : '') + '>Numerique</option><option value="date" ' + (columnTypes[header] === 'date' ? 'selected' : '') + '>Date</option></select></div></div>';
                }).join('');
                state.mapping = mapping;
                state.columnTypes = columnTypes;
            }

            window.updateMapping = function (source, target) {
                state.mapping[source] = target;
            }

            window.updateColumnType = function (source, type) {
                state.columnTypes[source] = type;
            }

            window.autoDetectTypes = function () {
                var headers = state.sourceHeaders;
                var preview = state.previewData.preview;
                if (!preview || !headers) return;

                var updates = 0;
                headers.forEach(function (h) {
                    if (state.ignoredColumns.includes(h)) return;

                    var samples = preview.map(function (r) { return r[h]; }).filter(function (v) {
                        return v !== null && v !== undefined && v !== '';
                    });

                    if (samples.length === 0) return;

                    var isNumeric = samples.every(function (v) {
                        return !isNaN(parseFloat(v)) && isFinite(v);
                    });

                    // D√©tection de date am√©lior√©e : ISO, FR, US, Excel Serial
                    var isDate = samples.every(function (v) {
                        if (!v) return false;
                        var s = String(v).trim();

                        // 1. Excel Serial Number (uniquement si le nom de colonne contient "date")
                        var asNum = parseFloat(v);
                        var isDateCol = /date|time|heure|cree|maj/i.test(h);
                        if (!isNaN(asNum) && isFinite(asNum) && asNum > 10000 && asNum < 70000 && isDateCol) {
                            return true;
                        }

                        // 2. Regex strictes
                        // YYYY-MM-DD
                        if (/^\d{4}-\d{2}-\d{2}/.test(s)) return true;
                        // DD/MM/YYYY
                        if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)) return true;
                        // DD-MM-YYYY
                        if (/^\d{1,2}-\d{1,2}-\d{4}/.test(s)) return true;
                        // DD.MM.YYYY
                        if (/^\d{1,2}\.\d{1,2}\.\d{4}/.test(s)) return true;
                        // Heure seule HH:MM:SS
                        if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)) return true;

                        // 3. Date.parse (moteur JS, sensible √† la locale mais utile en dernier recours)
                        var d = Date.parse(s);
                        return !isNaN(d);
                    });

                    var type = 'text';
                    if (isDate) type = 'date';
                    else if (isNumeric) type = 'numeric';

                    if (state.columnTypes[h] !== type) {
                        state.columnTypes[h] = type;
                        updates++;
                    }
                });

                if (updates > 0) {
                    displayMapping();
                    // Petit feedback visuel
                    var btn = document.querySelector('button[onclick="autoDetectTypes()"]');
                    var oldText = btn.textContent;
                    btn.textContent = '‚úÖ ' + updates + ' types mis √† jour';
                    setTimeout(function () { btn.textContent = oldText; }, 2000);
                } else {
                    alert('Aucun changement de type d√©tect√©.');
                }
            }

            function snakeCase(str) {
                if (!str) return str;
                return str.toLowerCase()
                    .replace(/[\s\-]+/g, '_')
                    .replace(/[^a-z0-9_]/g, '')
                    .replace(/_+/g, '_')
                    .substring(0, 63)
                    .replace(/_$/, '');
            }

            function setupStep4() {
                var targetTable = state.importMode === 'append' ? document.getElementById('existingTableSelect').value : document.getElementById('newTableName').value;
                var sheetSelect = document.getElementById('sheetSelect');
                var sheetName = sheetSelect ? sheetSelect.value : null;

                document.getElementById('summaryRows').textContent = state.previewData ? state.previewData.total_rows : 0;
                document.getElementById('summaryColumns').textContent = state.sourceHeaders.length;
                document.getElementById('summaryTable').textContent = targetTable;
                document.getElementById('importResult').style.display = 'none';
                document.getElementById('importBtn').style.display = 'inline-flex';
                document.getElementById('importBtn').disabled = false;
                document.getElementById('importBtn').textContent = 'Lancer l\'import';
            }

            window.executeImport = function () {
                var targetTable = state.importMode === 'append' ? document.getElementById('existingTableSelect').value : document.getElementById('newTableName').value;
                var endpoint = state.importMode === 'append' ? 'append' : 'create';
                var splitDatetime = document.getElementById('splitDatetimeCheckbox').checked;
                var hotelId = document.getElementById('hotelIdInput') ? document.getElementById('hotelIdInput').value : 'Primary';

                var payload = {
                    filename: state.uploadedFile.filepath,
                    sheet_name: document.getElementById('sheetSelect') ? document.getElementById('sheetSelect').value : null,
                    table_name: targetTable,
                    hotel_id: hotelId, // Toujours envoyer hotelId si pr√©sent
                    column_mapping: state.mapping,
                    column_types: state.columnTypes,
                    split_datetime: splitDatetime,
                    split_datetime: splitDatetime,
                    ignored_rows: state.ignoredRows,
                    ignored_columns: state.ignoredColumns,
                    ignored_rows: state.ignoredRows,
                    ignored_columns: state.ignoredColumns,
                    header_row: state.headerRowIndex,
                    custom_headers: state.headerRowIndex === -1 ? state.customHeaders : null
                };

                var btn = document.getElementById('importBtn');
                btn.disabled = true;
                btn.textContent = 'Importation en cours...';

                fetch(API_BASE + '/import/' + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        if (data.error) {
                            showImportError(data.error);
                        } else {
                            showImportSuccess(data);
                        }
                    })
                    .catch(function (error) { showImportError(error.message); });
            }

            function showImportSuccess(data) {
                var btn = document.getElementById('importBtn');
                btn.style.display = 'none';
                var res = document.getElementById('importResult');
                res.innerHTML = '<div class="message message-success"><strong>Import reussi!</strong><p>' + (data.rows_inserted || 0) + ' ligne(s) inseree(s) dans la table "' + data.table_name + '"</p></div>';
                if (data.warning) {
                    res.innerHTML += '<div class="message message-warning"><strong>Attention:</strong><p>' + data.warning + '</p><pre style="background:#eee;padding:10px;margin-top:10px;font-size:12px;overflow:auto">' + (data.sql_script || '') + '</pre></div>';
                }
                res.style.display = 'block';
            }

            function showImportError(error) {
                var btn = document.getElementById('importBtn');
                btn.disabled = false;
                btn.textContent = 'Lancer l\'import';
                var res = document.getElementById('importResult');

                var displayMsg = typeof error === 'object' ? JSON.stringify(error, null, 2) : error;

                res.innerHTML = '<div class="message message-error"><strong>Erreur lors de l\'import</strong><pre style="white-space: pre-wrap; font-size: 11px; margin-top: 5px; background: rgba(0,0,0,0.05); padding: 5px;">' + displayMsg + '</pre></div>';
                res.style.display = 'block';
            }

            function loadTemplates() {
                fetch(API_BASE + '/templates')
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        state.templates = data.templates || [];
                        renderTemplates();
                        updateTemplateSelects();
                    })
                    .catch(function (error) { console.error('Erreur:', error); });
            }

            function renderTemplates() {
                var container = document.getElementById('templateList');
                if (!container) return;
                if (state.templates.length === 0) {
                    container.innerHTML = '<li class="template-item"><div class="template-item-name">Aucun template</div><div class="template-item-table">Creez votre premier import</div></li>';
                    return;
                }
                container.innerHTML = state.templates.map(function (t) {
                    return '<li class="template-item" style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<div style="flex: 1; cursor: pointer;" onclick="applyTemplate(\'' + t.id + '\')">' +
                        '<div class="template-item-name">' + t.name + '</div>' +
                        '<div class="template-item-table">' + (t.target_table || 'N/A') + '</div>' +
                        '</div>' +
                        '<button class="btn btn-secondary btn-sm" style="background: transparent; border: none; font-size: 1.2rem; padding: 4px 8px;" onclick="deleteTemplate(\'' + t.id + '\', event)">üóëÔ∏è</button>' +
                        '</li>';
                }).join('');
            }

            window.deleteTemplate = function (templateId, event) {
                if (event) event.stopPropagation();
                if (!confirm('Supprimer ce modele ?')) return;

                fetch(API_BASE + '/templates/' + templateId, {
                    method: 'DELETE'
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        if (data.success) {
                            loadTemplates();
                        } else {
                            alert('Erreur: ' + (data.error || 'Inconnue'));
                        }
                    })
                    .catch(function (error) { alert('Erreur: ' + error.message); });
            }

            window.saveTemplate = function () {
                var name = document.getElementById('templateName').value.trim();
                if (!name) { alert('Veuillez entrer un nom pour le modele'); return; }

                var targetTable = state.importMode === 'append' ? document.getElementById('existingTableSelect').value : document.getElementById('newTableName').value;

                var payload = {
                    name: name,
                    target_table: targetTable,
                    column_mapping: state.mapping,
                    column_types: state.columnTypes
                };

                fetch(API_BASE + '/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        if (data.error) { alert('Erreur: ' + data.error); }
                        else {
                            alert('Modele enregistre avec succes');
                            loadTemplates();
                        }
                    })
                    .catch(function (error) { alert('Erreur: ' + error.message); });
            };

            window.applyTemplate = function (templateId) {
                if (!state.uploadedFile) { alert('Veuillez d\'abord uploader un fichier'); return; }
                fetch(API_BASE + '/templates/' + templateId + '/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: state.uploadedFile.filepath })
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        if (data.error) { alert(data.error); return; }
                        var template = data.template;

                        if (template.target_table) {
                            if (state.targetTables.includes(template.target_table)) {
                                window.switchTab('append');
                                var sel = document.getElementById('existingTableSelect');
                                if (sel) {
                                    sel.value = template.target_table;
                                    window.loadTableColumns(template.target_table);
                                }
                            } else {
                                window.switchTab('create');
                                var nt = document.getElementById('newTableName');
                                if (nt) nt.value = template.target_table;
                            }
                        }

                        state.mapping = template.column_mapping || {};
                        state.columnTypes = template.column_types || {};

                        window.goToStep(3);
                    })
                    .catch(function (error) { alert('Erreur: ' + error.message); });
            }

            function checkSupabaseConnection() {
                fetch(API_BASE + '/health')
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        var statusDot = document.getElementById('statusDot');
                        var statusText = document.getElementById('statusText');
                        if (!statusDot || !statusText) return;

                        if (data.supabase === 'connected') {
                            statusDot.className = 'status-dot connected';
                            statusText.textContent = 'Supabase: Connecte';
                        } else if (data.status === 'degraded') {
                            statusDot.className = 'status-dot degraded';
                            statusText.textContent = 'Supabase: Degrade';
                        } else {
                            statusDot.className = 'status-dot disconnected';
                            statusText.textContent = 'Supabase: Erreur';
                        }
                    })
                    .catch(function () {
                        var sd = document.getElementById('statusDot');
                        var st = document.getElementById('statusText');
                        if (sd) sd.className = 'status-dot disconnected';
                        if (st) st.textContent = 'API Hors-ligne';
                    });
            }

            window.toggleAide = function () {
                var modal = document.getElementById('aideModal');
                if (modal) {
                    modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
                }
            }

            window.openHotelManager = function () {
                var modal = document.getElementById('hotelModal');
                if (modal) {
                    modal.style.display = 'block';
                    loadHotelList();
                }
            }

            window.closeModal = function (modalId) {
                var modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            }

            function loadHotelList() {
                var container = document.getElementById('hotelListContainer');
                if (!container) return;
                container.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">Chargement...</td></tr>';

                fetch(API_BASE + '/hotels')
                    .then(response => response.json())
                    .then(data => {
                        if (data.hotels && data.hotels.length > 0) {
                            window.state.hotels = data.hotels; // Store in global state
                            container.innerHTML = data.hotels.map(h => `
                                <tr>
                                    <td><strong>${h.hotel_id}</strong></td>
                                    <td>${h.hotel_name}</td>
                                    <td>
                                        <button class="btn btn-secondary btn-sm" onclick="window.deleteHotel('${h.id}')">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('');
                            updateHotelSelects(); // Sync dropdowns
                        } else {
                            container.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">Aucun h√¥tel enregistr√©</td></tr>';
                        }
                    })
                    .catch(err => {
                        container.innerHTML = '<tr><td colspan="3" style="text-align:center; color: #EF4444;">Erreur: ' + err.message + '</td></tr>';
                    });
            }

            window.createHotel = function () {
                var idInput = document.getElementById('newHotelId');
                var nameInput = document.getElementById('newHotelName');
                var hotel_id = idInput.value.trim();
                var hotel_name = nameInput.value.trim();

                if (!hotel_id || !hotel_name) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }

                fetch(API_BASE + '/hotels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hotel_id, hotel_name })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            idInput.value = '';
                            nameInput.value = '';
                            loadHotelList();
                        } else {
                            alert('Erreur: ' + (data.error || 'Inconnue'));
                        }
                    })
                    .catch(err => alert('Erreur: ' + err.message));
            }

            window.deleteHotel = function (id) {
                if (!confirm('Supprimer cet h√¥tel ?')) return;
                fetch(API_BASE + '/hotels/' + id, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) loadHotelList();
                        else alert('Erreur: ' + (data.error || 'Inconnue'));
                    })
                    .catch(err => alert('Erreur: ' + err.message));
            }

            window.switchAppMode = function (mode) {
                var manual = document.getElementById('manualWizard');
                var auto = document.getElementById('autoModeContainer');
                var btnManual = document.getElementById('btnModeManual');
                var btnAuto = document.getElementById('btnModeAuto');

                if (mode === 'auto') {
                    manual.style.display = 'none';
                    auto.style.display = 'block';
                    btnManual.className = 'btn btn-secondary btn-sm';
                    btnAuto.className = 'btn btn-primary btn-sm';
                } else {
                    manual.style.display = 'block';
                    auto.style.display = 'none';
                    btnManual.className = 'btn btn-primary btn-sm';
                    btnAuto.className = 'btn btn-secondary btn-sm';
                }
            }

            function updateHotelSelects() {
                var selects = ['hotelIdInput', 'autoHotelId']; // Both manual and auto
                selects.forEach(id => {
                    var sel = document.getElementById(id);
                    if (!sel) return;
                    var currentVal = sel.value;
                    sel.innerHTML = '<option value="">Choisir un h√¥tel...</option>' +
                        (window.state.hotels || []).map(h => `<option value="${h.hotel_id}">${h.hotel_name} (${h.hotel_id})</option>`).join('');
                    if (currentVal) sel.value = currentVal;
                });
            }

            function updateTemplateSelects() {
                var sel = document.getElementById('manualTemplateSelect');
                if (!sel) return;
                sel.innerHTML = '<option value="">S√©lectionner un mod√®le...</option>' +
                    state.templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }

            // --- Logique Mode Automatique ---
            var autoDropzone = document.getElementById('autoDropzone');
            var autoFileInput = document.getElementById('autoFileInput');

            if (autoDropzone && autoFileInput) {
                autoDropzone.onclick = () => autoFileInput.click();
                autoDropzone.ondragover = (e) => { e.preventDefault(); autoDropzone.classList.add('active'); };
                autoDropzone.ondragleave = () => autoDropzone.classList.remove('active');
                autoDropzone.ondrop = (e) => {
                    e.preventDefault();
                    autoDropzone.classList.remove('active');
                    if (e.dataTransfer.files.length) handleAutoFile(e.dataTransfer.files[0]);
                };
                autoFileInput.onchange = (e) => {
                    if (e.target.files.length) handleAutoFile(e.target.files[0]);
                };
            }

            function handleAutoFile(file) {
                var hotelId = document.getElementById('autoHotelId').value;
                var category = document.getElementById('autoCategory').value;

                if (!hotelId) { alert('Veuillez s√©lectionner un h√¥tel d\'abord'); return; }

                // Reset UI
                var status = document.getElementById('autoStatus');
                var msg = document.getElementById('autoStatusMessage');
                var logs = document.getElementById('autoLogs');
                status.style.display = 'block';
                msg.className = 'message message-info';
                msg.innerHTML = '<strong>Upload en cours...</strong>';
                logs.innerHTML = '> Analyse du fichier: ' + file.name + '\n';

                // Step 1: Upload
                var formData = new FormData();
                formData.append('file', file);

                fetch(API_BASE + '/upload', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) throw new Error(data.error);
                        logs.innerHTML += '> Upload r√©ussi.\n';

                        // Si cat√©gorie Auto, on peut tenter de d√©tecter via le nom du fichier
                        if (!category) {
                            category = detectCategory(file.name);
                            if (category) {
                                logs.innerHTML += '> Cat√©gorie d√©tect√©e: ' + category + '\n';
                                document.getElementById('autoCategory').value = category;
                            } else {
                                throw new Error('Cat√©gorie non d√©tect√©e. Veuillez la s√©lectionner manuellement.');
                            }
                        }

                        // OTA Insight Special Case: Need to ask for tab if not provided
                        if (category === 'RAPPORT OTA INSIGHT') {
                            showOtaTabSelector(data.filepath, hotelId, category);
                            return;
                        }

                        // Step 2: Auto Process
                        return triggerAutoProcess(data.filepath, hotelId, category);
                    })
                    .catch(err => {
                        msg.className = 'message message-error';
                        msg.innerHTML = '<strong>Erreur:</strong> ' + err.message;
                        logs.innerHTML += '!! ERREUR: ' + err.message + '\n';
                    });
            }

            function detectCategory(filename) {
                var fn = filename.toUpperCase();
                if (fn.includes('PLANNING')) return 'RAPPORT PLANNING D-EDGE';
                if (fn.includes('RESERVATIONS EN COURS')) return 'RAPPORT R√âSERVATIONS EN COURS D-EDGE';
                if (fn.includes('HISTORIQUE')) return 'RAPPORT HISTORIQUE DES R√âSERVATIONS';
                if (fn.includes('OTA')) return 'RAPPORT OTA INSIGHT';
                if (fn.includes('SALON') || fn.includes('EVENEMENT')) return 'DATES SALONS ET √âV√âNEMENTS';
                return null;
            }

            function triggerAutoProcess(filename, hotelId, category, tabName = null) {
                var msg = document.getElementById('autoStatusMessage');
                var logs = document.getElementById('autoLogs');

                logs.innerHTML += '> Lancement du traitement expert...\n';

                return fetch(API_BASE + '/auto-process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, hotel_id: hotelId, category, tab_name: tabName })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) throw new Error(data.error);
                        msg.className = 'message message-success';
                        msg.innerHTML = '<strong>Succ√®s !</strong> ' + data.rows_inserted + ' lignes import√©es dans ' + data.target_table;
                        logs.innerHTML += '> Traitement termin√© avec succ√®s.\n';
                        logs.innerHTML += '> Table: ' + data.target_table + '\n';
                        logs.innerHTML += '> Lignes: ' + data.rows_inserted + '\n';
                    });
            }

            function showOtaTabSelector(filename, hotelId, category) {
                var container = document.getElementById('otaTabsContainer');
                var btnGrid = document.getElementById('otaTabsButtons');
                container.style.display = 'block';

                var tabs = ["Aper√ßu", "Tarifs", "vs. Hier", "vs. 3 jours", "vs. 7 jours"];
                btnGrid.innerHTML = tabs.map(t => `<button class="btn btn-outline-primary btn-sm" onclick="window.processOtaTab('${filename}', '${hotelId}', '${category}', '${t}')">${t}</button>`).join('');

                document.getElementById('autoStatusMessage').innerHTML = '<strong>Attention:</strong> Fichier OTA Insight d√©tect√©. Veuillez choisir l\'onglet √† importer.';
            }

            window.processOtaTab = function (filename, hotelId, category, tabName) {
                document.getElementById('otaTabsContainer').style.display = 'none';
                triggerAutoProcess(filename, hotelId, category, tabName);
            }

            window.openCacheManager = function () {
                var modal = document.getElementById('cacheModal');
                if (modal) {
                    modal.style.display = 'block';
                    loadCacheList();
                }
            }

            window.closeCacheManager = function () {
                var modal = document.getElementById('cacheModal');
                if (modal) modal.style.display = 'none';
            }

            function loadCacheList() {
                var container = document.getElementById('cacheListContainer');
                if (!container) return;
                container.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Chargement...</td></tr>';

                fetch(API_BASE + '/cache')
                    .then(response => response.json())
                    .then(data => {
                        if (data.files && data.files.length > 0) {
                            container.innerHTML = data.files.map(f => {
                                var date = new Date(f.created_at).toLocaleString('fr-FR');
                                var size = (f.size / 1024).toFixed(1) + ' KB';
                                return `<tr>
                                    <td>${f.filename}</td>
                                    <td>${date}</td>
                                    <td>${size}</td>
                                    <td><button class="btn btn-secondary btn-sm" onclick="window.deleteCacheFile('${f.filename}')">üóëÔ∏è</button></td>
                                </tr>`;
                            }).join('');
                        } else {
                            container.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Le cache est vide</td></tr>';
                        }
                    })
                    .catch(err => {
                        container.innerHTML = '<tr><td colspan="4" style="text-align:center; color: #EF4444;">Erreur: ' + err.message + '</td></tr>';
                    });
            }

            window.deleteCacheFile = function (filename) {
                if (!confirm('Supprimer ce fichier du cache ?')) return;
                fetch(API_BASE + '/cache/' + filename, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) loadCacheList();
                        else alert('Erreur: ' + (data.error || 'Inconnue'));
                    })
                    .catch(err => alert('Erreur: ' + err.message));
            }

            window.clearAllCache = function () {
                if (!confirm('Voulez-vous vraiment vider TOUT le cache ?')) return;
                fetch(API_BASE + '/cache', { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.deleted_count + ' fichiers supprim√©s');
                            loadCacheList();
                        } else {
                            alert('Erreur: ' + (data.error || 'Inconnue'));
                        }
                    })
                    .catch(err => alert('Erreur: ' + err.message));
            }

            function initializeApp() {
                loadTables();
                loadTemplates();
                loadHotelList(); // Added to load hotels on start
            }

            document.addEventListener('DOMContentLoaded', initializeApp);
            setTimeout(checkSupabaseConnection, 1000);
        })();
    </script>
</body>

</html>